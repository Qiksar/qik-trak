version: "3.6"

services:
  qiktrak_db:
    env_file: .env

    container_name: qiktrak_db
    image: postgres

    volumes:
      - ./initdb:/docker-entrypoint-initdb.d/

    ports:
      - "7000:5432"

    restart: always

  qiktrak_gql:
    env_file: .env

    image: hasura/graphql-engine:latest
    container_name: qiktrak_gql

    links:
      - qiktrak_db

    ports:
      - "7001:8080"

    command:
      - graphql-engine
      - serve

    restart: always

  # Use this if you want to build the app into a container that you can run from the docker
  qik-trak:
    env_file: .env
    environment:
      - HASURA_GRAPHQL_ENDPOINT=http://qiktrak_gql:8080

    container_name: qik-trak
    image: registry.digitalocean.com/sndk8/qiktrak:latest

    build:
      context: .
      dockerfile: ./Dockerfile

    links:
      - qiktrak_db
      - qiktrak_gql

    command:
      - node
      - qik-trak-cli.js
